@model IEnumerable<PMTs.DataAccess.ComplexModel.MasterDataRoutingModel>

@using Microsoft.AspNetCore.Http;
@using Microsoft.AspNetCore.Mvc.Localization
@using PMTs.WebApplication.Extentions;
@using PMTs.DataAccess.ModelView.Login;

@inject IViewLocalizer Localizer
@inject IHttpContextAccessor httpContextAccessor

@{
    ViewData["Title"] = "Change Board New Material";
    var userSession = SessionExtentions.GetSession<UserSessionModel>(httpContextAccessor.HttpContext.Session, "UserSessionModel");
    var saleOrg = userSession.SaleOrg.ToString();
    var factoryCode = userSession.FactoryCode.ToString();
}

<style>
    .center {
        margin: auto;
        width: 100%;
        padding: 10px;
    }

    .swal-footer {
        text-align: center;
    }

    #selectedBoardValues option:hover {
        color: red;
        cursor: pointer;
    }

    #selectedGradeValues option:hover {
        color: red;
        cursor: pointer;
    }

    #selectedCustomerValues option:hover {
        color: red;
        cursor: pointer;
    }

</style>

<br />
<div class="row">
    <div class="col-12">
        <div class="card" style="padding-top:0px;margin-top:0px">
            <div class="card-body">
                <div class="row box">
                    <div class="col-md-4">
                        <h3 class="text-themecolor"><i class="mdi mdi-content-copy"></i> &nbsp;@Localizer["Change Board New Material"] </h3>
                    </div>
                    <div class="col-md-5">
                       
                    </div>
                    <div class="col-md-3">
                       
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="acBoard">Board</label>
                        <input class="form-control text-center" type="text" id="acBoard" placeholder="-- Please search board --" />
                        <select class="form-control" id="selectedBoardValues" multiple></select>
                    </div>
                    <div class="col-md-4">
                        <label for="acGrade">Grade</label>
                        <input type="text" class="form-control text-center" id="acGrade" placeholder="-- Please search grade --" />
                        <select class="form-control" id="selectedGradeValues" multiple></select>
                    </div>
                    <div class="col-md-4">
                        <label for="acCustomer">Customer</label>
                        <input type="text" class="form-control text-center" id="acCustomer" placeholder="-- Please search customer --" />
                        <select class="form-control" id="selectedCustomerValues" multiple></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 text-right">
                        <input type="text" name="fileDownloadWithData" id="fileDownloadWithData" style="display:none;" value="">
                        <a href="#0" class="btn btn-outline-primary" onclick="thisFileDownloadWithData()">@Localizer["Load Template With Data"]&ensp;<i class="fa fa-download"></i></a>
                        <label for="fileDownloadWithData"></label>
                    </div>
                    <div class="col-md-6 text-left">
                        <input type="text" name="fileDownload" id="fileDownload" style="display:none;" value="">
                        <a href="#0" class="btn btn-outline-success" onclick="thisFileDownload()">@Localizer["Load Blank Template"]&ensp;<i class="fa fa-download"></i></a>
                        <label for="fileDownload"></label>
                    </div>
                </div>

                <div class="box">
                    <div class="box-body">
                        <div style="background-color:white;padding:20px 0px;" class="text-center">
                            @Localizer["Copy material and change board to new material"]
                        <div style="background-color:white;" class="text-center">@Localizer["The import file size limitation is 100KB."] </div>
                    </div>
                    <div style="background-color:white;height:14vh" class="text-center">
                        <form id="fromChangeBoardNewMaterial">
                            <div id="textFieled" class="form-group row">
                                <div class="col-md-12">
                                    <input type="file" name="fileUpload" id="fileUpload" style="display:none;" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                                    <a href="#0" class="btn btn-outline-info" style="min-height:35px;min-width:170px;" onclick="thisFileUpload();">@Localizer["Change Board New Material From File"]&ensp;<i class="fa fa-upload"></i></a>
                                    <label for="fileUpload"></label>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="divCheckImport" hidden>
                        <div id="divDisplayFailedItem">
                            <div style="background-color:white;padding:20px 0px;" class="text-center font-bold text-danger">@Localizer["Failed Change Board New Material"]</div>

                            <div id="divFailedChangeBoardNewMaterialTable" class="table-responsive">
                                <partial name="_FailedChangeBoardNewMaterialTable" model="Model" />
                            </div>
                        </div>

                        <div id="textAlready"></div>

                        <div style="background-color:white;padding:20px 0px;" class="text-center font-bold text-success">@Localizer["Success Change Board New Material"]</div>
                        <div id="divAlreadyChangeBoardNewMaterialTable" class="table-responsive">
                            <partial name="_AlreadyChangeBoardNewMaterialTable" model="Model" />
                        </div>
                        <div class="form-inline" style="flex-flow:row-reverse;padding-top:20px">
                            <div>
                                <input class="btn btn-info" style="min-width:100px" hidden type="button" id="btn-ConfirmChangeBoardNewMat" value="@Localizer["Next"]">
                            </div>
                        </div>
                    </div>

                    <div hidden id="divChangeBoardNewMaterialTable" class="table-responsive">
                        <div style="background-color:white;padding:20px 0px;" class="text-center font-bold text-info">@Localizer["Change Board New Material List"]</div>

                        <partial name="_ChangeBoardNewMaterialTable" model="Model" />
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <!-- Datatable CSS -->
    <link rel="stylesheet" type="text/css" href="~/DataTable/css/datatables.min.css" />
    <link rel="stylesheet" type="text/css" href="~/DataTable/css/buttons.dataTables.min.css" />
    <script type="text/javascript" src="~/DataTable/js/datatables.min.js"></script>
    <script type="text/javascript" src="~/lib/DataTables/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="~/lib/DataTables/buttons.colVis.min.js"></script>
    <script src="~/lib/DataTables/pdfmake.min.js"></script>
    <script src="~/lib/DataTables/vfs_fonts.js"></script>
    <script type="text/javascript" src="~/lib/DataTables/jszip.min.js"></script>

    <script>
        let failedCount = 0;
        const BoardList = @Html.Raw(Json.Serialize(@ViewBag.Boards));
        const CustomerList = @Html.Raw(Json.Serialize(@ViewBag.Customers));
        const GradeList = @Html.Raw(Json.Serialize(@ViewBag.Grades));

        window.pdfMake.fonts = {
            THSarabunNew: {
                normal: 'THSarabunNew.ttf',
                bold: 'THSarabunNew.ttf',
                italics: 'THSarabunNew.ttf"',
                bolditalics: 'THSarabunNew.ttf',
            }
        };

        $(document).ready(function () {
            // var searchType = $("#searchType")[0];
            // searchType.value = "Board";
            // searchType.dispatchEvent(new Event("change"));
            failedCount = 0;
            $("#fileDownload").val("");
            $("#btn-ConfirmChangeBoardNewMat").attr("hidden", true);
            $("#divCheckImport").attr("hidden", true);
            $("#divChangeBoardNewMaterialTable").attr("hidden", true);
            $("#divDisplayFailedItem").attr("hidden", true);
            $("#btn-ConfirmChangeBoardNewMat").attr('disabled', true);

            $('#ChangeBoardNewMaterialTable').DataTable({
                'bFilter': true,
                "paging": true,
                "scrollX": true,
                "dom": '<"float-left"l><"float-right"f>rt<"float-left"i><"float-right"p>'
            });

            $('#FailedChangeBoardNewMaterialTable').DataTable({
                'bFilter': true,
                "paging": true,
                "scrollX": true,
                "dom": '<"float-left"l><"float-right"f>rt<"float-left"i><"float-right"p>'
            });

            $('#AlreadyChangeBoardNewMaterialTable').DataTable({
                'bFilter': true,
                "paging": true,
                "scrollX": true,
                "dom": '<"float-left"l><"float-right"f>rt<"float-left"i><"float-right"p>'
            });
        });

        var CustomerAutoCompleteData = $.map(CustomerList, function (item) {
            return {
                label: item.CustCode != null ? item.CusId + " " + item.CustCode.trim() + " " + item.CustName.trim() : item.CusId + " " + item.CustCode + " " + item.CustName.trim(),
                value: item.CusId,
            }
        });
        var BoardAutoCompleteData = $.map(BoardList, function (item) {
            return {
                label: item,
                value: item,
            }
        });
        var GradeAutoCompleteData = $.map(GradeList, function (item) {
            return {
                label: item,
                value: item,
            }
        });
        // $("#searchType").on('change', function () {
        //     var type = $(this).val()
        //     $("#selectedValues option").each(function () {
        //         $(this).remove();
        //     });
        //     if (type === 'Board') {
        //         $("#acBoard").attr("hidden", false);
        //         $("#acGrade").attr("hidden", true);
        //         $("#selectedValues").attr("hidden", false);
        //         $("#acCustomer").attr("hidden", true);
        //     } else if (type === 'Grade') {
        //         $("#acBoard").attr("hidden", true);
        //         $("#acGrade").attr("hidden", false);
        //         $("#selectedValues").attr("hidden", false);
        //         $("#acCustomer").attr("hidden", true);
        //     } else if (type === 'Customer') {
        //         $("#acBoard").attr("hidden", true);
        //         $("#acGrade").attr("hidden", true);
        //         $("#selectedValues").attr("hidden", false);
        //         $("#acCustomer").attr("hidden", false);
        //     }
        // })

        $("#acBoard").autocomplete({
            maxShowItems: 10,
            source: BoardAutoCompleteData,
            select: function (event, ui) {
                event.preventDefault();

                var option = $("<option>").val(ui.item.value).text(ui.item.label);

                $("#selectedBoardValues").append(option);

                $(this).val('');

                return false;
            }
        });
       
        $("#acGrade").autocomplete({
            maxShowItems: 10,
            source: GradeAutoCompleteData,
            select: function (event, ui) {
                event.preventDefault();

                var option = $("<option>").val(ui.item.value).text(ui.item.label);

                $("#selectedGradeValues").append(option);

                $(this).val('');

                return false;
            }
           
        });
        $("#acCustomer").autocomplete({
            maxShowItems: 10,
            source: CustomerAutoCompleteData,
            select: function (event, ui) {
                event.preventDefault();

                var option = $("<option>").val(ui.item.value).text(ui.item.label);

                $("#selectedCustomerValues").append(option);

                $(this).val('');

                return false;
            }
        })
        $("#selectedBoardValues").on("hover", "option", function () {
            console.log($(this));
        });
        $("#selectedBoardValues").on("click", "option", function () {
            $(this).remove();
        });
        $("#selectedGradeValues").on("click", "option", function () {
            $(this).remove();
        });
        $("#selectedCustomerValues").on("click", "option", function () {
            $(this).remove();
        });

        function thisFileUpload() {
            document.getElementById("fileUpload").click();
        };

        function thisFileDownload() {
            $("#fileDownload").val("download");

            swal({
                title: "Are you sure?",
                text: "Export change board new material template.",
                icon: "warning",
                buttons: {
                    confirm: "Ok",
                    cancel: true,
                },
                dangerMode: false,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        document.location.href = '@Url.Action("ExportChangeBoardNewMaterialTemplate", "MaintenanceProductInfo")';
                    }
                });
        };
        function thisFileDownloadWithData() {
            $("#fileDownloadWithData").val("download");
            var selectedBoardValues = []
            var selectedGradeValues = []
            var selectedCustomerValues = []

            $("#selectedBoardValues option").each(function () {
                selectedBoardValues.push($(this)[0].value);
            });
            $("#selectedGradeValues option").each(function () {
                selectedGradeValues.push($(this)[0].value);
            });
            $("#selectedCustomerValues option").each(function () {
                selectedCustomerValues.push($(this)[0].value);
            });
            var data = {
                // typeSearch: $("#searchType").val(),
                boards: [],
                grades: [],
                customers: [],
            };
            // if ($("#searchType").val() == 'Board') {
            //     data.boards = selectedValues
            // } else if ($("#searchType").val() == 'Grade') {
            //     data.grades = selectedValues
            // } else if ($("#searchType").val() == 'Customer') {
            //     data.customers = selectedValues
            // }
            data.boards = selectedBoardValues
            data.grades = selectedGradeValues
            data.customers = selectedCustomerValues
            
            console.log(data)
            swal({
                title: "Are you sure?",
                text: "Export change board new material template.",
                icon: "warning",
                buttons: {
                    confirm: "Ok",
                    cancel: true,
                },
                dangerMode: false,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        // document.location.href = '@Url.Action("ExportChangeBoardNewMaterialTemplate", "MaintenanceProductInfo")';
                        $.ajax({
                            url: '@Url.Action("ExportChangeBoardNewMaterialTemplateWithData", "MaintenanceProductInfo")',
                            type: 'POST', 
                            data: data,
                            xhrFields: {
                                responseType: 'blob'
                            },
                            success: function (response) {
                                const href = window.URL.createObjectURL(response)
                                const a = document.createElement('a')
                                a.style.display = 'none'
                                a.href = href
                                a.download = 'PMTs-ChangeBoardNewMaterialTemplate.xlsx'
                                document.body.appendChild(a)
                                a.click()
                                window.URL.revokeObjectURL(href)
                            },
                            error: function () {
                            }
                            // success: function (response) {
                            //     var blob = new Blob([response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                            //     var link = document.createElement('a');
                            //     link.href = window.URL.createObjectURL(blob);
                            //     link.download = "PMTs-ChangeBoardNewMaterialTemplate.xlsx";
                            //     link.click();
                            // },
                            // error: function (xhr, status, error) {
                            //     console.error(xhr.responseText);
                            // }
                        });
                    }
                });
        };

        $('#fileUpload').click(function () {
            document.getElementById("fileUpload").value = null;
        });

        $('#fileUpload').change(function () {
            swal({
                title: "Are you sure?",
                text: "Import excel data to change board new material",
                icon: "warning",
                buttons: {
                    confirm: "Ok",
                    cancel: true,
                },
                dangerMode: false,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        let form = $('#fromChangeBoardNewMaterial')[0];
                        let data = new FormData(form);
                        data.append('checkImport', true);
                        //alert("chenge :"+ $("#divChangeBoardNewMaterialTable").is(":hidden"));
                        //alert("failed :" + $("#divFailedChangeBoardNewMaterialTable").is(":hidden"));

                        $.ajax({
                            type: 'POST',
                            enctype: 'multipart/form-data',
                            url: '@Url.Action("ImportChangeBoardNewMaterialFromExcel", "MaintenanceProductInfo")',
                            data: data,
                            async: false,
                            processData: false,
                            contentType: false,
                            cache: false,
                            success: function (res) {
                                if (res.IsSuccess)
                                {
                                    $("#divCheckImport").attr("hidden", false);

                                    if (!isNaN(parseInt(res.FailedCount)) && parseInt(res.FailedCount) > 0)
                                    {
                                        failedCount = parseInt(res.FailedCount);
                                        $("#divDisplayFailedItem").attr("hidden", false);
                                        $('#divFailedChangeBoardNewMaterialTable').html(res.ViewFaileds);
                                        $('#FailedChangeBoardNewMaterialTable').DataTable({
                                            "scrollX": true,
                                            "order": [],
                                            "dom": 'Bfrt<"float-left"i>p',
                                            "paging": true,
                                            "autoWidth": true,
                                            "buttons": [

                                                {
                                                    extend: 'excelHtml5',
                                                    messageTop: "รายการ copy material ใหม่โดยเปลี่ยน board",
                                                    text: 'ดาวน์โหลด Excel',
                                                    createEmptyCells: true,
                                                    exportOptions: {
                                                        title: null,
                                                        orthogonal: 'export'
                                                    },
                                                    customize: function (xlsx) {
                                                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                                        // Loop over the cells
                                                        $('row c', sheet).each(function () {
                                                            //select the index of the row
                                                            var numero = $(this).parent().index();
                                                            var residuo = numero % 2;
                                                            if (numero == 1) {
                                                                $(this).attr('s', '51');
                                                            } else if (numero == 2) {
                                                                $(this).attr('s', '47');
                                                            } else if (numero > 1) {
                                                                if (residuo == 0) {//'is t',
                                                                    $(this).attr('s', '25');
                                                                } else {
                                                                    $(this).attr('s', '30');
                                                                }
                                                            }
                                                        });
                                                    },
                                                }
                                            ],
                                            "oLanguage": {
                                                "sSearch": "ค้นหา:"
                                            }
                                        });
                                        document.getElementById("textFieled").scrollIntoView();
                                    }
                                    else
                                    {
                                        $("#divDisplayFailedItem").attr("hidden", true);
                                        document.getElementById("textFieled").scrollIntoView();
                                        //document.getElementById("textAlready").scrollIntoView();
                                    }

                                    $('#divAlreadyChangeBoardNewMaterialTable').html(res.ViewAlreadys);

                                    $('#AlreadyChangeBoardNewMaterialTable').DataTable({
                                        'bFilter': true,
                                        "paging": true,
                                        "order": [],
                                        "scrollX": true,
                                        "dom": '<"float-left"l><"float-right"f>rt<"float-left"i><"float-right"p>'
                                    });

                                    $('.modal-backdrop').css('display', 'none');
                                    $("#btn-ConfirmChangeBoardNewMat").attr("hidden", false);

                                    if (!isNaN(parseInt(res.AlreadyCount)) && parseInt(res.AlreadyCount) > 0) {
                                        $("#btn-ConfirmChangeBoardNewMat").attr('disabled', false);
                                    }
                                    else
                                    {
                                        $("#btn-ConfirmChangeBoardNewMat").attr('disabled', true);
                                    }

                                    $("#divChangeBoardNewMaterialTable").attr("hidden", true);

                                    if (!isNaN(parseInt(res.FailedCount)) && parseInt(res.FailedCount) > 0) {

                                        $("#file-upload").val("");
                                        swal({
                                            title: "Found invalid data",
                                            text: "Do you want to download invalid data?",
                                            icon: "warning",
                                            buttons: {
                                                confirm: "Ok",
                                                cancel: true,
                                            },
                                            dangerMode: false,
                                        })
                                            .then((willDelete) => {
                                                //#region Download Filed Check board
                                                if (failedCount > 0 && willDelete) {
                                                    setTimeout(function () {
                                                        document.location.href = '@Url.Action("ExportInvalidChangeBoardNewMaterialDataTemplate", "MaintenanceProductInfo")';

                                                        //$("#FailedChangeBoardNewMaterialTable_wrapper .buttons-excel").click();
                                                    }, 1000);

                                                }
                                                //#endregion
                                            });
                                    }
                                }
                                else
                                {
                                    swal("PMTs Failed!", res.ExceptionMessage , {icon:"warning"})
                                        .then(()=> {
                                            window.location.href = "@Url.Action("ChangeBoardNewMaterial", "MaintenanceProductInfo")";
                                    });
                                }
                            },
                            error: function () {
                            // return false;
                            }
                        });
                    }
                });
        });

        function DisabledSubmitButton(item) {
            item.disabled = true;

            setTimeout(function () {
                item.disabled = false;
            }, 2000);
        }

        $("#btn-ConfirmChangeBoardNewMat").click(function () {
            let alreadyBtnDisabled = $("#btn-ConfirmChangeBoardNewMat").is(":disabled");

            if (!alreadyBtnDisabled) {
                swal({
                    title: "Change Board New Mat",
                    text: "DO you want to continue creating new mat?",
                    icon: "warning",
                    buttons: {
                    confirm: "Ok",
                    cancel: true,
                    },
                    dangerMode: false,
                    })
                    .then((willDelete) => {
                        if (willDelete) {
                            //#region Confirm to change board new mat
                        let data = new FormData();
                        data.append('checkImport', false);

                        $.ajax({
                            type: 'POST',
                            enctype: 'multipart/form-data',
                            url: '@Url.Action("ImportChangeBoardNewMaterialFromExcel", "MaintenanceProductInfo")',
                            data: data,
                            async: false,
                            processData: false,
                            contentType: false,
                            cache: false,
                            success: function (res) {
                                if (res.IsSuccess)
                                {
                                    $("#divCheckImport").attr("hidden", true);
                                    $("#divChangeBoardNewMaterialTable").attr("hidden", false);

                                    $('#divChangeBoardNewMaterialTable').html(res.View);
                                    $('.modal-backdrop').css('display', 'none');
                                    $('#ChangeBoardNewMaterialTable').DataTable({
                                        "scrollX": true,
                                        "order": [[0, "asc"]],
                                        "dom": 'Bfrt<"float-left"i>p',
                                        "paging": true,
                                        "autoWidth": true,
                                        "buttons": [

                                            {
                                                extend: 'excelHtml5',
                                                messageTop: "รายการ copy material ใหม่โดยเปลี่ยน board",
                                                text: 'ดาวน์โหลด Excel',
                                                createEmptyCells: true,
                                                exportOptions: {
                                                    title: null,
                                                    orthogonal: 'export'
                                                },
                                                customize: function (xlsx) {
                                                    var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                                    // Loop over the cells
                                                    $('row c', sheet).each(function () {
                                                        //select the index of the row
                                                        var numero = $(this).parent().index();
                                                        var residuo = numero % 2;
                                                        if (numero == 1) {
                                                            $(this).attr('s', '51');
                                                        } else if (numero == 2) {
                                                            $(this).attr('s', '47');
                                                        } else if (numero > 1) {
                                                            if (residuo == 0) {//'is t',
                                                                $(this).attr('s', '25');
                                                            } else {
                                                                $(this).attr('s', '30');
                                                            }
                                                        }
                                                    });
                                                },
                                            }
                                        ],
                                        "oLanguage": {
                                            "sSearch": "ค้นหา:"
                                        }
                                    });

                                    swal("PMTs Change Board New Mat!", "Save success.", { icon: "info" });
                                }
                                else
                                {
                                    swal("PMTs Failed!", res.ExceptionMessage , {icon:"warning"})
                                        .then(()=> {
                                            window.location.href = "@Url.Action("ChangeBoardNewMaterial", "MaintenanceProductInfo")";
                                    });
                                }
                            },
                            error: function () {

                            }
                        });

                        //#endregion
                        }
                    });
            }

        });
    </script>
}